{% extends 'new_design/base.html' %}
{% load static %}

{% block title %}
Пользователи
{% endblock %}

{% block style %}
<style>
    table {
        margin-bottom: 50px;
    }
    thead tr td{
        font-weight: 600;
    }
    tr, td {
        padding: 15px 30px;
        height: 50px;
        cursor:pointer;
    }
    tbody tr:hover{
        background: #e8e8e8 !important;
    }


    .profileBlock {
        display: none;
        position: absolute;
        width: 300px;
        min-height: 230px;
        background: white;
        right: 150px;
        margin: auto;
        border-radius: 10px;
        box-shadow: 0 2px 2px 0 rgb(0 0 0 / 14%), 0 3px 1px -2px rgb(0 0 0 / 12%), 0 1px 5px 0 rgb(0 0 0 / 20%);
        padding:10px;
        justify-content: start;
        flex-direction: column;
    }
    .profileBlock::before{
        content: "";
        height: 10px;
        width: 10px;
        border-bottom: 10px solid #ffffff00;
        border-top: 10px solid #ffffff00;
        border-left: 10px solid white;
        position: absolute;
        top: 66px;
        right: -10px;
    }
    .profileBlockItem{
        display: flex;
        justify-content: space-between;
    }
    .profileBlock img{
        border-radius: 3px;
        display: block;
        margin: 3px auto;
    }
    .profileBlockItem span:last-child{
        text-align: right;
    }
    .user_actions{
        text-align: right;
    }
    .user_actions a{
        border-right: 1px solid #e0e0e0;
        padding:0px 5px;
    }
    .userModal{
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        width: 500px;
        border-top:1px solid #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
  <div id="modal_create" class="modal">
    <div class="modal-content">
      <h4>Modal Header</h4>
      <p>A bunch of text</p>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
    </div>
  </div>

    <div id="modal_delete" class="modal userModal">
        <div class="modal-content">
          <h5 class="deleteModalTitle">Удаление</h5>
          <p>
            Вы действительно хотите удалить данного пользователя, отменить это действие будет невозможно</p>
        </div>
        <div class="modal-footer">
          <a href="#!" class="modal-close waves-effect waves-grey btn-flat">Нет</a>
          <a href="#!" class="modal-close waves-effect waves-green btn-flat" data-pk="" id="deleteModalButton" onclick="deleteUser(this)">Да</a>
        </div>
    </div>


<div class="">
    <table class="table-striped">
        <thead>
        <tr>
            <td>ФИО</td>
            <td>Должность</td>
            <td>Номер</td>
            <td class="user_actions">Действия</td>
        </tr>
        </thead>
        <tbody>
        {% for i in users %}
            <tr  data-id="userItem_{{ i.pk }}">
                <td>{{ i.last_name }} {{ i.first_name }} {{ i.username }}</td>
                <td>{{ i.profile.position }}</td>
                <td>{{ i.profile.mobile }}</td>
                <td class="user_actions">
                        <a href="#modal_edit" class="modal-trigger" onclick="getUserForApi(this, id={{i.pk}}, count={{forloop.counter}}, 'show')"><i class="material-icons more_icon">more_vert</i></a>
                        <a href="#modal_edit" class="modal-trigger" onclick="selectTag({{i.pk}})"><i class="material-icons edit_icon">edit</i></a>
                        <a href="#modal_delete" class="modal-trigger" onclick="buttonAddId({{ i.pk }})"><i class="material-icons delete_icon">delete</i></a>
                </td>
                <div class="profileBlock" id="profileBlock_{{i.pk}}"></div>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

   <div class="fixed-action-btn">
        <a class="btn-floating btn-large pulse modal-trigger" href="#modal_create" style="background: #58a5ff !important">
          <i class="large material-icons">add</i>
        </a>
   </div>
{% endblock %}

{% block script %}
<script>
     var preloader = '<div class="preloader-wrapper big active" style="\n' +
                 '    margin: 150px auto;\n' +
                 '    display: block;\n' +
                 '">\n' +
                 '        <div class="spinner-layer spinner-blue-only">\n' +
                 '      <div class="circle-clipper left">\n' +
                 '        <div class="circle"></div>\n' +
                 '      </div><div class="gap-patch">\n' +
                 '        <div class="circle"></div>\n' +
                 '      </div><div class="circle-clipper right">\n' +
                 '        <div class="circle"></div>\n' +
                 '      </div>\n' +
                 '    </div>\n' +
                 '    </div>';

        function notDisplay(list){
                 list.forEach(
                     (elem) => {
                         elem.style.display = "none";
                     }
                 )
                }

     function backgroundInherit(list){
            list.forEach((elem)=>{
                elem.style.backgroundColor = "inherit";
            })
        }

     async function getUserForApi(elem, id, count, visible){
        let trs = document.querySelectorAll("tr");
        backgroundInherit(trs);
        elem.parentElement.parentElement.style.backgroundColor = "#e8e8e8";
        //elem.id = `userItem_${pk}`;
        let url = `/fetch/users/${id}`;
        let openBlocks = document.querySelectorAll(".profileBlock");
        notDisplay(openBlocks);
        let block = getBlock(id, visible);
        visible === 'show' ?
                await fetch(url).then(async response => {
                  if (response.status === 200) {
                      let dataAPI = await response.json();
                      setBlock(block, await generateUserData(id, dataAPI));
                  } else {
                    throw new Error(response.status);
                  }
                }).catch((error)=>{
                    console.log(error);
                  setBlock(block, "<div class='connection_error'>Ошибка <br> Нет связи с сервером</div>");
            }) :
            setBlock(block, "");
    }

      function getBlock(id, visible) {
            let style = visible === "show" ? `display:flex;top:${count * 60 + 10}px;` : "display:none;"
            let block = document.getElementById(`profileBlock_${id}`);

            block.style = style;
            block.innerHTML = preloader;

            return block;
        }

     function generateUserData(id, data) {
         //let picture = data.profile.picture !== null ? data.profile.picture : '{% static "img/user.png" %}';
         //console.log(picture);//<img src="${picture}" width="240px" height="240px" alt="">
         let signature = '';
         let position = '';
         let mobile = '';
         let birth_date = '';
         let picture = '';
         if (data.profile !== null){
            signature = data.profile.signature !== null ? `<img src="${data.profile.signature}" width="200px" height="200px" alt="">` : '';
            mobile = data.profile.mobile !== null ? data.profile.mobile : '';
            position = data.profile.position !== null ? data.profile.position : '';
            birth_date = data.profile.birth_date !== null ? data.profile.birth_date : '';
            picture = data.profile.picture !== null ? data.profile.picture : '';
         }
         return data !== 'error' ? `
                <div class="profileBlockItem">
                    <span>ФИО:</span>
                    <span>${data.first_name} ${data.last_name}</span>
                </div>
                <div class="profileBlockItem">
                    <span>Должность:</span>
                    <span>${position}</span>
                </div>
                <div class="profileBlockItem">
                    <span>Почта:</span>
                    <span>${data.email}</span>
                </div>
                <div class="profileBlockItem">
                    <span>Мобильный:</span>
                    <span>${mobile}</span>
                </div>
                <div class="profileBlockItem">
                    <span>Дата рождения:</span>
                    <span>${birth_date}</span>
                </div>
                ${signature}
        ` : `<div>Ошибка</div>`;

    }

    function setBlock(elem, text){
        elem.innerHTML = text;
    }



</script>
<script>
    /*Тут удаление*/
      function getBlock(id, visible) {
            let style = visible === "show" ? `display:flex;top:${count * 60 + 10}px;` : "display:none;"
            let block = document.getElementById(`profileBlock_${id}`);

            block.style = style;
            block.innerHTML = preloader;

            return block;
        }

    function buttonAddId(pk){
          getBlock(pk, "hide");
        let elem = document.getElementById("deleteModalButton");
        elem.setAttribute("data-pk", pk);
    }

    async function deleteUser(elem){
        let pk = elem.getAttribute("data-pk");
        url = `/fetch/user/delete/${pk}`;
        await fetch(url, {
            method: "delete",
        }).then(async response=>{
            if (response.status === 200){
                deleteInList(pk);
                successDeleteToast();
            }else{
                errorConnectionToast();
                throw new Error(response.status);
            }
        }).catch(error => {
            errorConnectionToast();
            console.log(error);})
    }

    function deleteInList(pk){
        let user_item = document.querySelectorAll(`tr[data-id='userItem_${pk}']`)[0];
        console.log(user_item);
        user_item.remove();
    }

    function successDeleteToast(){
            M.toast({html: 'Пользователь удален', classes: "toastSuccess"})
    }


    /*Ошибка при отсутсвии интернета и серверных ошибках(редактирование, удаление, создание)*/
    function errorConnectionToast(){
        M.toast({html: 'Ошибка', classes: "toastError"})
    }
</script>
{% endblock %}